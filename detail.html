<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Material</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1 class="header">⚡ DETAIL MATERIAL PLN ⚡</h1>

  <div style="text-align:center;">
    <h2 id="judulUtama"></h2>
    <h3 id="subJudul" style="color:#555; margin-top:-10px;"></h3>
  </div>

  <div style="max-width:95%; margin:auto;">
    <table id="detailTable" border="1" style="width:100%; border-collapse:collapse; text-align:center;">
      <thead style="background:#007AC3; color:white;">
        <tr id="tableHeader"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="config.js"></script>
  <script>
    async function loadDetail() {
      try {
        const params = new URLSearchParams(window.location.search);
        const kategori = params.get("kategori");
        const material = params.get("material");
        const kodeMaterial = params.get("kode");
        const tipe = params.get("tipe"); // <-- Tambahan penting untuk membedakan "kurang" dan "stock"

        const judul = document.getElementById("judulUtama");
        const sub = document.getElementById("subJudul");
        const tbody = document.querySelector("#detailTable tbody");
        const thead = document.querySelector("#tableHeader");
        tbody.innerHTML = "";

        // ====================================================
        // DETAIL DAFTAR TUNGGU
        // ====================================================
        if (kategori) {
          judul.textContent = kategori;
          sub.textContent = "Daftar Pelanggan";
          const range = "DAFTAR TUNGGU!A2:L3145";
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;

          const res = await fetch(url);
          if (!res.ok) {
            const text = await res.text();
            console.error("Gagal ambil DAFTAR TUNGGU:", res.status, text);
            thead.innerHTML = `<th colspan="8" style="color:red;">Gagal mengambil data (status ${res.status})</th>`;
            return;
          }

          const data = await res.json();
          const values = data.values || [];

          thead.innerHTML = `
            <th>No</th><th>ULP</th><th>Bulan</th><th>Prioritas</th>
            <th>Tarif</th><th>Daya Lama</th><th>Daya Baru</th><th>Jumlah</th>
          `;

          let no = 1;
          values.forEach(r => {
            if (r[11] === kategori) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${no++}</td>
                <td>${r[2] || ''}</td>
                <td>${r[3] || ''}</td>
                <td>${r[4] || ''}</td>
                <td>${r[6] || ''}</td>
                <td>${r[7] || ''}</td>
                <td>${r[8] || ''}</td>
                <td>${r[9] || ''}</td>
              `;
              tbody.appendChild(tr);
            }
          });
        }

        // ====================================================
        // DETAIL STOCK MATERIAL
        // ====================================================
        if (material && kodeMaterial && !tipe) {
          judul.textContent = material;
          sub.textContent = `Kode Material: ${kodeMaterial}`;

          const range = "DETAIL STOCK MATERIAL!B2:Q";
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
          const res = await fetch(url);
          if (!res.ok) {
            const text = await res.text();
            console.error("Gagal ambil DETAIL STOCK MATERIAL:", res.status, text);
            thead.innerHTML = `<th colspan="9" style="color:red;">Gagal mengambil data (status ${res.status})</th>`;
            return;
          }

          const data = await res.json();
          const rows = data.values || [];
          const filteredRows = rows.filter(row => (row[4] || "").trim() === (kodeMaterial || "").trim());

          thead.innerHTML = `
            <th>No</th><th>Nomor SPB</th><th>Vendor Pelaksana</th>
            <th>Awal</th><th>Akhir</th><th>Jumlah SPB</th>
            <th>Jumlah Diterima</th><th>Tgl Terima</th><th>Nilai SPB</th>
          `;

          let no = 1;
          filteredRows.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${no++}</td>
              <td>${r[0] || ''}</td>
              <td>${r[1] || ''}</td>
              <td>${r[2] || ''}</td>
              <td>${r[3] || ''}</td>
              <td>${r[5] || ''}</td>
              <td>${r[6] || ''}</td>
              <td>${r[7] || ''}</td>
              <td>${r[15] || ''}</td>
            `;
            tbody.appendChild(tr);
          });

          if (filteredRows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" style="color:red;">⚠️ Tidak ada data ditemukan untuk kode ${kodeMaterial}</td></tr>`;
          }
        }

        // ====================================================
        // DETAIL KEKURANGAN MATERIAL (FITUR BARU)
        // ====================================================
        if (material && kodeMaterial && tipe === "kurang") {
          judul.textContent = material;
          sub.textContent = `Kode Material: ${kodeMaterial} (Kekurangan Material)`;

          const range = "DETAIL MATERIAL KURANG!B2:L";
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
          const res = await fetch(url);
          if (!res.ok) {
            const text = await res.text();
            console.error("Gagal ambil DETAIL MATERIAL KURANG:", res.status, text);
            thead.innerHTML = `<th colspan="8" style="color:red;">Gagal mengambil data (status ${res.status})</th>`;
            return;
          }

          const data = await res.json();
          const rows = data.values || [];
          // Kolom kode material = I (index 7 jika mulai dari B)
          const filteredRows = rows.filter(row => (row[7] || "").trim() === (kodeMaterial || "").trim());

          thead.innerHTML = `
            <th>No</th><th>No. SPK</th><th>Nama Pelanggan</th>
            <th>Alamat</th><th>Rayon</th><th>Vendor</th>
            <th>Tarif</th><th>Tanggal</th><th>Jumlah</th>
          `;

          let no = 1;
          filteredRows.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${no++}</td>
              <td>${r[0] || ''}</td>  <!-- B -->
              <td>${r[1] || ''}</td>  <!-- C -->
              <td>${r[2] || ''}</td>  <!-- D -->
              <td>${r[3] || ''}</td>  <!-- E -->
              <td>${r[4] || ''}</td>  <!-- F -->
              <td>${r[5] || ''}</td>  <!-- G -->
              <td>${r[9] || ''}</td>  <!-- K -->
              <td>${r[10] || ''}</td> <!-- L -->
            `;
            tbody.appendChild(tr);
          });

          if (filteredRows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" style="color:red;">⚠️ Tidak ada data ditemukan untuk kode ${kodeMaterial}</td></tr>`;
          }
        }
      } catch (err) {
        console.error("Terjadi error di loadDetail():", err);
        const tbody = document.querySelector("#detailTable tbody");
        tbody.innerHTML = `<tr><td colspan="9" style="color:red;">Terjadi error saat memuat data. Cek console.</td></tr>`;
      }
    }

    loadDetail();
  </script>
</body>
</html>
