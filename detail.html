<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detail Material</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* sedikit styling agar langsung rapi */
    .header-row { display:flex; align-items:center; justify-content:center; gap:12px; margin-top:12px; }
    .nav-buttons { text-align:center; margin:12px 0; }
    .btn { padding:8px 12px; margin:0 6px; border:none; border-radius:6px; cursor:pointer; background:#007AC3; color:#fff; }
    #filterContainer { text-align:center; margin:12px 0; }
    #filterContainer input, #filterContainer select { padding:6px 8px; margin:4px; border-radius:6px; border:1px solid #ccc; width:180px; }
    table { width:100%; border-collapse:collapse; }
    table th, table td { padding:8px 6px; border:1px solid #ddd; text-align:center; }
    .card { cursor:pointer; } /* in case reused */
    .msg { text-align:center; color:#555; margin:18px 0; }
  </style>
</head>
<body>
  <div class="header-row">
    <img src="assets/logo-pln.png" alt="PLN" style="width:56px;height:auto;">
    <h1>‚ö° DETAIL MATERIAL PLN ‚ö°</h1>
  </div>

  <div class="nav-buttons">
    <button class="btn" onclick="goBack()">‚¨ÖÔ∏è Kembali</button>
    <button class="btn" onclick="goHome()">üè† Home</button>
    <button class="btn" onclick="resetFilters()">üîÑ Reset Filter</button>
  </div>

  <div style="text-align:center;">
    <h2 id="judulUtama"></h2>
    <h3 id="subJudul" style="color:#555; margin-top:-8px;"></h3>
  </div>

  <div id="filterContainer"></div>

  <div style="max-width:95%; margin:auto;">
    <table id="detailTable">
      <thead style="background:#007AC3; color:white;">
        <tr id="tableHeader"></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="emptyMsg" class="msg" style="display:none;"></div>
  </div>

  <script src="config.js"></script>
  <script>
    function goBack(){ history.back(); }
    function goHome(){ location.href = "index.html"; }

    // helper: create input or select and return element
    function createInput(id, placeholder){ const i = document.createElement("input"); i.id=id; i.placeholder=placeholder; return i; }
    function createSelect(id, opts){ const s = document.createElement("select"); s.id=id; opts.forEach(o=>{ const el=document.createElement("option"); el.value=o.value; el.textContent=o.label; s.appendChild(el); }); return s; }

    async function loadDetail(){
      try {
        const params = new URLSearchParams(location.search);

        // accept both old param names and new ones
        const ulpParam = params.get("ulp");               // NEW: from dashboard cards
        const kategori = params.get("kategori");         // BACKWARD: support old links
        const material = params.get("material");
        const kodeMaterial = params.get("kode");

        const judul = document.getElementById("judulUtama");
        const sub = document.getElementById("subJudul");
        const tbody = document.querySelector("#detailTable tbody");
        const thead = document.getElementById("tableHeader");
        const filterContainer = document.getElementById("filterContainer");
        const emptyMsg = document.getElementById("emptyMsg");
        tbody.innerHTML = ""; thead.innerHTML = ""; filterContainer.innerHTML = ""; emptyMsg.style.display = "none"; emptyMsg.textContent = "";

        // determine filter key (ulp has priority)
        const filterKey = (ulpParam && ulpParam.trim() !== "") ? ulpParam.trim() : (kategori || "").trim();

     // ---------- DAFTAR TUNGGU (filter by ULP/kategori) ----------
if (filterKey) {
  judul.textContent = filterKey;
  sub.textContent = "Daftar Pelanggan";

  // Ambil header untuk mengetahui kode material (kolom M..BS)
  const hdrRange = "DAFTAR TUNGGU!A1:BS1";
  const hdrUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${hdrRange}?key=${CONFIG.API_KEY}`;
  const hdrRes = await fetch(hdrUrl);
  const hdrData = await hdrRes.json();
  const headerRow = (hdrData.values && hdrData.values[0]) || [];
  const materialHeaders = headerRow.slice(12); // M = index 12

  // Ambil data utama A2:L
  const range = "DAFTAR TUNGGU!A2:L3145";
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  const rows = data.values || [];

  // Ambil sheet BAHAN (kode ‚Üí nama, satuan)
  const bahanRange = "BAHAN!A2:C";
  const bahanUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${bahanRange}?key=${CONFIG.API_KEY}`;
  const bahanRes = await fetch(bahanUrl);
  const bahanData = await bahanRes.json();
  const bahanRows = bahanData.values || [];
  const kodeMap = {};
  bahanRows.forEach(r => {
    const nama = r[0] || "";
    const kode = (r[1] || "").toString().trim();
    const satuan = r[2] || "";
    if (kode) kodeMap[kode] = { nama, satuan };
  });

  // ------------------- TABEL HEADER -------------------
  thead.innerHTML = `
    <th>No</th>
    <th>Bulan</th>
    <th>Prioritas</th>
    <th>Nama Pelanggan</th>
    <th>Tarif</th>
    <th>Daya Lama</th>
    <th>Daya Baru</th>
    <th>Jumlah</th>
    <th>Total Daya Baru</th>
    <th>Klasifikasi</th>
    <th>Detail</th>
  `;

  // Filter awal berdasarkan ULP (kolom C / index 2)
  const filteredRows = rows.filter(r => (r[2] || "").trim() === filterKey);

  if (filteredRows.length === 0) {
    emptyMsg.style.display = "block";
    emptyMsg.textContent = `‚ö†Ô∏è Tidak ada data Daftar Tunggu untuk '${filterKey}'.`;
  } else {

    // ==========================================================
    //       FUNGSI ‚Äî PANEL MATERIAL DETAIL (KEBAWAH)
    // ==========================================================
    function toggleMaterialPanel(button, rowData) {

      // Tutup jika sudah terbuka
      const tr = button.closest("tr");
      const next = tr.nextElementSibling;
      if (next && next.classList.contains("material-panel")) {
        next.remove();
        button.textContent = "‚ûú";
        return;
      }

      // Tutup panel lain
      document.querySelectorAll(".material-panel").forEach(e => e.remove());
      document.querySelectorAll(".detail-btn").forEach(b => b.textContent = "‚ûú");
      button.textContent = "‚ñº";

      // Buat panel baru
      const panel = document.createElement("tr");
      panel.className = "material-panel";
      const colCount = thead.querySelectorAll("th").length;

      const cell = document.createElement("td");
      cell.colSpan = colCount;
      cell.style.padding = "14px";
      cell.style.background = "#fafafa";

      // ----------- INFORMASI DETAIL PELANGGAN ----------------
      const namaPelanggan = rowData[5] || "";
      const dayaLama = rowData[7] || "";
      const dayaBaru = rowData[8] || "";
      const jumlah = rowData[9] || "";

      const headerHTML = `
        <div style="margin-bottom:14px; font-size:14px; line-height:1.6;">
          <b>Nama Pelanggan:</b> ${namaPelanggan}<br>
          <b>Daya Lama:</b> ${dayaLama}<br>
          <b>Daya Baru:</b> ${dayaBaru}<br>
          <b>Jumlah:</b> ${jumlah}
        </div>
      `;

      // ------------------- TABEL MATERIAL -------------------
      const tbl = document.createElement("table");
      tbl.style.width = "100%";
      tbl.style.borderCollapse = "collapse";
      tbl.innerHTML = `
        <thead style="background:#eef3fa;">
          <tr>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Kode</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Nama Material</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Satuan</th>
            <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Kebutuhan</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tb = tbl.querySelector("tbody");

      // Loop material kolom M..BS (index 12 ‚Üí seterusnya)
      for (let i = 0; i < materialHeaders.length; i++) {
        const kode = (materialHeaders[i] || "").trim();
        const cellIndex = 12 + i;
        const jumlahMat = rowData[cellIndex];

        if (!jumlahMat || jumlahMat == "0") continue;

        const info = kodeMap[kode] || { nama: "(Nama tidak ditemukan)", satuan: "" };

        const trm = document.createElement("tr");
        trm.innerHTML = `
          <td style="padding:6px; border-bottom:1px solid #eee;">${kode}</td>
          <td style="padding:6px; border-bottom:1px solid #eee;">${info.nama}</td>
          <td style="padding:6px; border-bottom:1px solid #eee;">${info.satuan}</td>
          <td style="padding:6px; border-bottom:1px solid #eee;">${jumlahMat}</td>
        `;
        tb.appendChild(trm);
      }

      if (!tb.innerHTML.trim()) {
        tb.innerHTML = `<tr><td colspan="4" style="padding:6px;">Tidak ada material untuk pelanggan ini.</td></tr>`;
      }

      // Combine
      cell.innerHTML = headerHTML;
      cell.appendChild(tbl);
      panel.appendChild(cell);

      // Masukkan ke tabel
      tr.parentNode.insertBefore(panel, tr.nextSibling);
      panel.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    // ==========================================================
    //                RENDER TABEL UTAMA
    // ==========================================================
    function renderDaftar(list) {
      tbody.innerHTML = "";
      let no = 1;

      list.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${no++}</td>
          <td>${r[3] || ""}</td>
          <td>${r[4] || ""}</td>
          <td>${r[5] || ""}</td>
          <td>${r[6] || ""}</td>
          <td>${r[7] || ""}</td>
          <td>${r[8] || ""}</td>
          <td>${r[9] || ""}</td>
          <td>${r[10] || ""}</td>
          <td>${r[11] || ""}</td>
          <td style="text-align:center;">
            <button class="detail-btn" type="button">‚ûú</button>
          </td>
        `;
        tbody.appendChild(tr);

        const btn = tr.querySelector(".detail-btn");
        btn.addEventListener("click", e => {
          e.stopPropagation();
          toggleMaterialPanel(btn, r);
        });

        tr.addEventListener("click", () => {
          toggleMaterialPanel(btn, r);
        });
      });
    }

    // Render awal
    renderDaftar(filteredRows);

    // ==========================================================
    //                      FILTER MULTI
    // ==========================================================
    const fBulan = createInput("fBulan", "Filter Bulan");

    const fPrior = createSelect("fPrior", [
      { value: "", label: "Semua Prioritas" },
      { value: "1", label: "1" },
      { value: "2", label: "2" },
      { value: "3", label: "3" },
      { value: "eskalasi", label: "Eskalasi" }
    ]);

    const tarifUnique = [...new Set(filteredRows.map(rr => rr[6]).filter(Boolean))];
    const fTarif = createSelect(
      "fTarif",
      [{ value: "", label: "Semua Tarif" }]
      .concat(tarifUnique.map(t => ({ value: t, label: t })))
    );

    const klasUnique = [...new Set(filteredRows.map(rr => rr[11]).filter(Boolean))];
    const fKlas = createSelect(
      "fKlas",
      [{ value: "", label: "Semua Klasifikasi" }]
      .concat(klasUnique.map(k => ({ value: k, label: k })))
    );

    [fBulan, fPrior, fTarif, fKlas].forEach(el => {
      el.style.margin = "6px";
      filterContainer.appendChild(el);
    });

    [fBulan, fPrior, fTarif, fKlas].forEach(el => {
      el.addEventListener("input", () => {

        const bulanVal = (fBulan.value || "").toLowerCase();
        const priorVal = (fPrior.value || "").toLowerCase();
        const tarifVal = (fTarif.value || "").toLowerCase();
        const klasVal = (fKlas.value || "").toLowerCase();

        const filtered = filteredRows.filter(r => {

          const bulan = (r[3] || "").toLowerCase();
          const prior = (r[4] || "").toLowerCase();
          const tarif = (r[6] || "").toLowerCase();
          const klas = (r[11] || "").toLowerCase();

          if (bulanVal && !bulan.includes(bulanVal)) return false;
          if (priorVal && !prior.startsWith(priorVal)) return false;
          if (tarifVal && tarif !== tarifVal) return false;
          if (klasVal && klas !== klasVal) return false;

          return true;
        });

        renderDaftar(filtered);
      });
    });
  }

  return; // selesai mode daftar tunggu
}

}


        // ---------- STOCK MATERIAL (detail by kode) ----------
        if (material && kodeMaterial) {
          judul.textContent = material;
          sub.textContent = `Kode Material: ${kodeMaterial}`;

          // ambil detail stock
          const rangeStock = "DETAIL STOCK MATERIAL!B2:Q";
          const urlStock = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${rangeStock}?key=${CONFIG.API_KEY}`;
          const resStock = await fetch(urlStock);
          const dataStock = await resStock.json();
          const rowsStock = dataStock.values || [];

          // kode material ada di kolom F => index 4 karena range mulai B
          const filteredStock = rowsStock.filter(r => (r[4]||"").trim() === (kodeMaterial||"").trim());

          thead.innerHTML = `
            <th>No</th><th>Nomor SPB</th><th>Vendor Pelaksana</th>
            <th>Awal</th><th>Akhir</th><th>Jumlah SPB</th>
            <th>Jumlah Diterima</th><th>Tgl Terima</th><th>Nilai SPB</th>
          `;

          if (filteredStock.length === 0) {
            emptyMsg.style.display = "block";
            emptyMsg.textContent = `‚ö†Ô∏è Tidak ada data stock untuk kode ${kodeMaterial}. Mencari di DETAIL MATERIAL KURANG...`;
          } else {
            function renderStock(list){
              tbody.innerHTML=""; let no=1;
              list.forEach(r=>{
                const tr=document.createElement("tr");
                tr.innerHTML = `
                  <td>${no++}</td>
                  <td>${r[0]||''}</td>
                  <td>${r[1]||''}</td>
                  <td>${r[2]||''}</td>
                  <td>${r[3]||''}</td>
                  <td>${r[5]||''}</td>
                  <td>${r[6]||''}</td>
                  <td>${r[7]||''}</td>
                  <td>${r[15]||''}</td>
                `;
                tbody.appendChild(tr);
              });
            }
            renderStock(filteredStock);

            // Filter inputs for stock (vendor, tanggal)
            const fVendor = createInput("fVendor","Filter Vendor");
            const fTgl = createInput("fTgl","Filter Tgl Terima");
            [fVendor,fTgl].forEach(el=>{el.style.margin="6px"; filterContainer.appendChild(el)});
            [fVendor,fTgl].forEach(el=>{
              el.addEventListener("input", ()=>{
                const v=(fVendor.value||"").toLowerCase();
                const t=(fTgl.value||"").toLowerCase();
                const filtered = filteredStock.filter(r=>{
                  const vendor=(r[1]||"").toLowerCase();
                  const tgl=(r[7]||"").toLowerCase();
                  if (v && !vendor.includes(v)) return false;
                  if (t && !tgl.includes(t)) return false;
                  return true;
                });
                renderStock(filtered);
              });
            });
          }

          // if no stock found -> fallback to DETAIL MATERIAL KURANG
          if (filteredStock.length === 0) {
            const rangeKurang = "DETAIL MATERIAL KURANG!B2:L";
            const urlKurang = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${rangeKurang}?key=${CONFIG.API_KEY}`;
            const resKurang = await fetch(urlKurang);
            const dataKurang = await resKurang.json();
            const rowsKurang = dataKurang.values || [];

            const filteredKurang = rowsKurang.filter(r => (r[7]||"").trim() === (kodeMaterial||"").trim());

            thead.innerHTML = `
              <th>No</th><th>No. SPK</th><th>Nama Pelanggan</th><th>Alamat</th>
              <th>Rayon</th><th>Vendor</th><th>Tarif</th><th>Tanggal</th><th>Jumlah</th>
            `;
            if (filteredKurang.length === 0) {
              emptyMsg.style.display = "block";
              emptyMsg.textContent = `‚ö†Ô∏è Tidak ada data di DETAIL MATERIAL KURANG juga untuk kode ${kodeMaterial}.`;
            } else {
              function renderKurang(list){
                tbody.innerHTML=""; let no=1;
                list.forEach(r=>{
                  const tr=document.createElement("tr");
                  tr.innerHTML = `
                    <td>${no++}</td>
                    <td>${r[0]||''}</td>
                    <td>${r[1]||''}</td>
                    <td>${r[2]||''}</td>
                    <td>${r[3]||''}</td>
                    <td>${r[4]||''}</td>
                    <td>${r[5]||''}</td>
                    <td>${r[9]||''}</td>
                    <td>${r[10]||''}</td>
                  `;
                  tbody.appendChild(tr);
                });
              }
              renderKurang(filteredKurang);

              // provide filters for rayon/vendor for this fallback view
              const fRayon = createInput("fRayon","Filter Rayon");
              const fVendorK = createInput("fVendorK","Filter Vendor");
              [fRayon,fVendorK].forEach(el=>{el.style.margin="6px"; filterContainer.appendChild(el)});

              [fRayon,fVendorK].forEach(el=>{
                el.addEventListener("input", ()=>{
                  const rv=(fRayon.value||"").toLowerCase();
                  const vv=(fVendorK.value||"").toLowerCase();
                  const filtered = filteredKurang.filter(r=>{
                    const rayon=(r[3]||"").toLowerCase();
                    const vendor=(r[4]||"").toLowerCase();
                    if (rv && !rayon.includes(rv)) return false;
                    if (vv && !vendor.includes(vv)) return false;
                    return true;
                  });
                  renderKurang(filtered);
                });
              });
            }
          }

          return; // selesai mode material/kode
        }

        // Jika tidak ada parameter yang dikenali
        emptyMsg.style.display = "block";
        emptyMsg.textContent = "‚ö†Ô∏è Tidak ada parameter yang diberikan. Kunjungi dashboard terlebih dahulu.";
      } catch (err) {
        console.error("Error loadDetail:", err);
        document.querySelector("#detailTable tbody").innerHTML =
          `<tr><td colspan="9" style="color:red;">Terjadi kesalahan saat memuat data. Cek console.</td></tr>`;
      }
    }

    function resetFilters(){
      document.querySelectorAll("#filterContainer input, #filterContainer select").forEach(i=>i.value="");
      // trigger input events if any
      document.querySelectorAll("#filterContainer input, #filterContainer select").forEach(i=>{
        i.dispatchEvent(new Event('input'));
      });
    }

    // jalankan
    loadDetail();
  </script>
</body>
</html>
