<script src="config.js"></script>
<script>
async function loadDetail() {
  try {
    const params = new URLSearchParams(window.location.search);
    const kategori = params.get("kategori");
    const material = params.get("material");
    const kodeMaterial = params.get("kode");

    const judul = document.getElementById("judulUtama");
    const sub = document.getElementById("subJudul");
    const tbody = document.querySelector("#detailTable tbody");
    const thead = document.querySelector("#tableHeader");
    tbody.innerHTML = "";

    // ============ DETAIL DARI DAFTAR TUNGGU ============
    if (kategori) {
      judul.textContent = kategori;
      sub.textContent = "Daftar Pelanggan";
      const range = "DAFTAR TUNGGU!A2:L3145";
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      const values = data.values || [];

      thead.innerHTML = `
        <th>No</th><th>ULP</th><th>Bulan</th><th>Prioritas</th>
        <th>Tarif</th><th>Daya Lama</th><th>Daya Baru</th><th>Jumlah</th>
      `;

      let no = 1;
      values.forEach(r => {
        if (r[11] === kategori) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${no++}</td>
            <td>${r[2] || ''}</td>
            <td>${r[3] || ''}</td>
            <td>${r[4] || ''}</td>
            <td>${r[6] || ''}</td>
            <td>${r[7] || ''}</td>
            <td>${r[8] || ''}</td>
            <td>${r[9] || ''}</td>
          `;
          tbody.appendChild(tr);
        }
      });
    }

    // ============ DETAIL DARI STOCK MATERIAL ============
    if (material && kodeMaterial) {
      judul.textContent = material;
      sub.textContent = `Kode Material: ${kodeMaterial}`;

      // Ambil data dari DETAIL STOCK MATERIAL
      const rangeStock = "DETAIL STOCK MATERIAL!B2:Q";
      const urlStock = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${rangeStock}?key=${CONFIG.API_KEY}`;
      const resStock = await fetch(urlStock);
      const dataStock = await resStock.json();
      const rowsStock = dataStock.values || [];

      // Filter berdasarkan kolom F (index 4)
      const filteredStock = rowsStock.filter(r => (r[4] || "").trim() === kodeMaterial.trim());
      if (filteredStock.length > 0) {
        thead.innerHTML = `
          <th>No</th><th>Nomor SPB</th><th>Vendor Pelaksana</th>
          <th>Awal</th><th>Akhir</th><th>Jumlah SPB</th>
          <th>Jumlah Diterima</th><th>Tgl Terima</th><th>Nilai SPB</th>
        `;

        let no = 1;
        filteredStock.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${no++}</td>
            <td>${r[0] || ''}</td>
            <td>${r[1] || ''}</td>
            <td>${r[2] || ''}</td>
            <td>${r[3] || ''}</td>
            <td>${r[5] || ''}</td>
            <td>${r[6] || ''}</td>
            <td>${r[7] || ''}</td>
            <td>${r[15] || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        // Jika tidak ditemukan di STOCK MATERIAL, cek di DETAIL MATERIAL KURANG
        const rangeKurang = "DETAIL MATERIAL KURANG!B2:L";
        const urlKurang = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${rangeKurang}?key=${CONFIG.API_KEY}`;
        const resKurang = await fetch(urlKurang);
        const dataKurang = await resKurang.json();
        const rowsKurang = dataKurang.values || [];

        // Kolom I = index 7 (karena mulai dari B)
        const filteredKurang = rowsKurang.filter(r => (r[7] || "").trim() === kodeMaterial.trim());

        thead.innerHTML = `
          <th>No</th><th>No. SPK</th><th>Nama Pelanggan</th><th>Alamat</th>
          <th>Rayon</th><th>Vendor</th><th>Tarif</th><th>Tanggal</th><th>Jumlah</th>
        `;

        let no = 1;
        filteredKurang.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${no++}</td>
            <td>${r[0] || ''}</td> <!-- B -->
            <td>${r[1] || ''}</td> <!-- C -->
            <td>${r[2] || ''}</td> <!-- D -->
            <td>${r[3] || ''}</td> <!-- E -->
            <td>${r[4] || ''}</td> <!-- F -->
            <td>${r[5] || ''}</td> <!-- G -->
            <td>${r[9] || ''}</td> <!-- K -->
            <td>${r[10] || ''}</td> <!-- L -->
          `;
          tbody.appendChild(tr);
        });

        if (filteredKurang.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" style="color:red;">⚠️ Tidak ada data ditemukan untuk kode ${kodeMaterial}</td></tr>`;
        }
      }
    }
  } catch (err) {
    console.error("Error di loadDetail():", err);
    const tbody = document.querySelector("#detailTable tbody");
    tbody.innerHTML = `<tr><td colspan="9" style="color:red;">Terjadi kesalahan saat memuat data.</td></tr>`;
  }
}

loadDetail();
</script>
